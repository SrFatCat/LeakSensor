# Контроллер пассивных датчиков протечки 
- До 20 каналов (шлейфов)
- Несколько датчиков на одном шлейфе (с одним терминальным резистором)
- Извещатель ввиде полоски адресных светодиодов (WS281x) и зуммера
- Оповещение о состоянии и протечке через Blynk
- Постоянный контроль состояния шлейфа (обрыв, короткое). Контроль шлейфов при старте (и/или по требованию) и отключение неисправных.
- Кнопка отключения зумера и повторной инициализации

## Решение
<sup>Незамысловатое</sup>
Фактически подарено мне @Serj из телеграмм-канала @mysensors_ru
В качестве сенсора используются два контакта из нержавейки на расстоянии 5мм.
Терминальный резистор на шлейф 470-500к, помехозащищенность достигается использованием RC фильтра на входе МК и программно - получением большой усредненной выборки. Отсутствие ложных срабатываний проверено на шлейфе до 60м (витая пара) в условиях промышленного помещения.

### Схема принципиальная
<sup>Примитивная</sup>
![](https://github.com/SrFatCat/LeakSensor/blob/master/image/Schematic_LeakSensor.png)
Практически, всё модульное. Основной модуль МК Arduino Mega 2560, внешний АЦП - модуль ADS1115, Сеть - модуль WS5500, питание WS2812 - модуль LM2596, разъемы для подключения шлейфов - плинты на плату KRON (изуверски извлеченные из старой патч-панели). Всё питается через штатное подключение Меги 12В от соседнего БИРПа.

### Печатная плата и исполнение
<sup>Инвалидское</sup>
Печатная плата односторонняя для ЛУТ или домашнего фотополимера. Односторонняя с перемычками. Делалось все под корпус для электрического щитка IEK, крепление на DIN-рейку.
![](https://github.com/SrFatCat/LeakSensor/blob/master/image/PCB_LeakSensor.png)
![](https://github.com/SrFatCat/LeakSensor/blob/master/image/LeakSensor1.jpg)
![](https://github.com/SrFatCat/LeakSensor/blob/master/image/LeakSensor2.jpg)

### Демо видео
<sup>Ни хрена не понятно, зато лампочки мигают</sup>
[видео](https://youtu.be/1K_5AmTVZUc "видео")

### Замечания по коду
+ Используемые библиотеки
 + SPI.h, Ethernet.h (стандартные) для W5500
 + BlynkSimpleEthernet.h это понятно BLYNK
 + Adafruit_NeoPixel.h для работы с WS2812
 + UniversalKeyboardDriver.h самописная для кнопок (аналоговых, цифровых, через I2C расширитель), но хватило бы и простого debounce
 + Wire.h и Adafruit_ADS1015.h для работы с ADS1115
+ В файле LeakSensor.h описания и реализация 3х классов CLeakSensor - работа с датчиком протечки, подключенном к аналоговому порту, CLeakSensorADS работа с датчиком протечки, подключенном к аналоговому внешнему АЦП, CBeeper для ассинхронного управления зумером (ну не нравится мне `tone()`!)
